<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Text & Image Generation</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Soft blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15); /* Deeper shadow */
            padding: 35px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            background-color: #ffe0b2; /* Light orange for warnings/errors */
            color: #e65100; /* Darker orange text */
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            display: none; /* Hidden by default */
            font-size: 0.95rem;
        }
        .image-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 10px;
            border: 1px solid #cbd5e1; /* gray-300 */
        }
        /* Custom file input styling */
        .custom-file-input {
            border: 2px dashed #93c5fd; /* blue-300 */
            background-color: #eff6ff; /* blue-50 */
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .custom-file-input:hover {
            border-color: #60a5fa; /* blue-400 */
            background-color: #e0f2fe; /* blue-100 */
        }
        .custom-file-input input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-6">AI Vision & Text Assistant</h1>

        <!-- Input area for user prompt -->
        <textarea
            id="promptInput"
            class="w-full p-5 border border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 text-gray-800 resize-y min-h-[120px] shadow-sm"
            placeholder="Describe what you see in the image, ask a question, or give a command (emojis welcome! ‚ú®)..."
            rows="6"
        ></textarea>

        <!-- Image Upload Area -->
        <label for="imageUpload" class="custom-file-input">
            <p class="text-blue-700 font-semibold text-lg mb-2">Drag & Drop or Click to Upload an Image üñºÔ∏è</p>
            <p class="text-gray-500 text-sm">PNG, JPG, JPEG allowed. Max 5MB.</p>
            <input type="file" id="imageUpload" accept="image/png, image/jpeg, image/jpg">
            <img id="imagePreview" src="#" alt="Image Preview" class="image-preview mx-auto hidden">
        </label>

        <!-- Generate button -->
        <button
            id="generateButton"
            class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-offset-2 flex items-center justify-center gap-2"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 11.17l-.803-.803A4.5 4.5 0 018 7.5a4.5 4.5 0 014-4.472A4.5 4.5 0 0116 7.5c0 1.282-.576 2.454-1.588 3.26L12 11.17zm3.172 1.306l.854.854A3.5 3.5 0 0019.5 15a3.5 3.5 0 003.5-3.5c0-.853-.339-1.637-.89-2.22l-.854-.854m-14.735 4.39l-.854.854A3.5 3.5 0 014.5 15a3.5 3.5 0 01-3.5-3.5c0-.853.339-1.637.89-2.22l.854-.854"></path></svg>
            Generate AI Response
        </button>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner"></div>

        <!-- Response area -->
        <div id="responseArea" class="bg-gray-50 p-7 rounded-xl border border-gray-200 shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">AI Response ‚ú®</h2>
            <p id="responseText" class="text-gray-700 leading-relaxed whitespace-pre-wrap text-lg">Your AI-generated text will appear here. Try asking about an image!</p>
        </div>

        <!-- Message Box for errors/info -->
        <div id="messageBox" class="message-box"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const promptInput = document.getElementById('promptInput');
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const generateButton = document.getElementById('generateButton');
            const responseText = document.getElementById('responseText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const messageBox = document.getElementById('messageBox');

            let base64ImageData = null; // To store the base64 string of the uploaded image

            /**
             * Displays a message in the message box.
             * @param {string} message - The message to display.
             * @param {boolean} isError - True if it's an error message, false otherwise.
             */
            function showMessage(message, isError = false) {
                messageBox.textContent = message;
                messageBox.style.display = 'block';
                messageBox.style.backgroundColor = isError ? '#ffebee' : '#e3f2fd'; /* Red for error, light blue for info */
                messageBox.style.color = isError ? '#c62828' : '#1565c0'; /* Dark red for error, dark blue for info */
            }

            /**
             * Hides the message box.
             */
            function hideMessageBox() {
                messageBox.style.display = 'none';
            }

            // Event listener for image file input change
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        showMessage('Image size exceeds 5MB limit. Please choose a smaller image.', true);
                        imagePreview.classList.add('hidden');
                        imageUpload.value = ''; // Clear the input
                        base64ImageData = null;
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                        // Extract base64 part (remove data:image/...;base64,)
                        base64ImageData = e.target.result.split(',')[1];
                    };
                    reader.onerror = () => {
                        showMessage('Failed to read image file. Please try again.', true);
                        imagePreview.classList.add('hidden');
                        base64ImageData = null;
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.classList.add('hidden');
                    base64ImageData = null;
                }
                hideMessageBox(); // Hide messages when a new file is selected
            });

            // Event listener for drag and drop
            const customFileInput = document.querySelector('.custom-file-input');
            customFileInput.addEventListener('dragover', (e) => {
                e.preventDefault();
                customFileInput.classList.add('border-blue-500', 'bg-blue-100');
            });

            customFileInput.addEventListener('dragleave', () => {
                customFileInput.classList.remove('border-blue-500', 'bg-blue-100');
            });

            customFileInput.addEventListener('drop', (e) => {
                e.preventDefault();
                customFileInput.classList.remove('border-blue-500', 'bg-blue-100');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageUpload.files = files; // Assign dropped files to the input
                    imageUpload.dispatchEvent(new Event('change')); // Trigger change event
                }
            });


            // Event listener for the generate button
            generateButton.addEventListener('click', async () => {
                const userPrompt = promptInput.value.trim(); // Get and trim the user input

                // Clear previous response and message
                responseText.textContent = 'Generating AI response...';
                hideMessageBox();

                if (!userPrompt && !base64ImageData) {
                    showMessage('Please enter a prompt or upload an image before generating.', false);
                    responseText.textContent = 'Your AI-generated text will appear here.';
                    return; // Exit if both prompt and image are empty
                }

                // Show loading spinner and disable button
                loadingSpinner.style.display = 'block';
                generateButton.disabled = true;
                generateButton.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    // Define the AI's identity and creator information as a system instruction or context
                    const aiIdentityContext = `You are Matrk AI, created by Koyamu Martin Kigozi. ` +
                                             `You can contact him at 0708825340 or via email at koyamumartinkigozi@gmail.com, ` +
                                             `from Bishop Dunstan Nsubuga Memorial Secondary School Kalangala.`;

                    // Prepare the payload for the Gemini API call
                    let chatHistory = [];

                    // Always include the AI's identity as the first part of the conversation for context
                    // This way the AI "knows" who it is when asked.
                    chatHistory.push({ role: "user", parts: [{ text: aiIdentityContext + "\n\n" + userPrompt }] });

                    // Add image part if image data exists
                    if (base64ImageData) {
                        chatHistory[0].parts.push({
                            inlineData: {
                                mimeType: "image/png", // Assuming PNG, but could be dynamic based on file type
                                data: base64ImageData
                            }
                        });
                    }

                    const payload = { contents: chatHistory };

                    // IMPORTANT: Leave apiKey as an empty string. The Canvas environment
                    // will automatically provide the API key at runtime for this model.
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    // Make the fetch call to the Gemini API
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Check if the response was successful (status code 2xx)
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                    }

                    // Parse the JSON response
                    const result = await response.json();

                    // Extract the generated text from the response
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        responseText.textContent = text; // Display the AI's response
                    } else {
                        // Handle cases where the response structure is unexpected or content is missing
                        showMessage('Received an unexpected response from the AI. Please try again.', true);
                        responseText.textContent = 'No response generated.';
                    }

                } catch (error) {
                    // Catch and display any errors during the API call
                    console.error('Error generating AI response:', error);
                    showMessage(`Failed to generate AI response: ${error.message}`, true);
                    responseText.textContent = 'Error: Could not generate response.';
                } finally {
                    // Hide loading spinner and re-enable button regardless of success or failure
                    loadingSpinner.style.display = 'none';
                    generateButton.disabled = false;
                    generateButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        });
    </script>
</body>
</html>
